<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motoristas Particulares em Porto Seguro</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            text-align: center;
            margin: 0;
            padding: 0;
            overflow-y: auto;
            transition: background-color 0.5s ease;
        }
        .container {
            max-width: 500px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            margin-bottom: 20px;
        }
        h2 {
            color: #4CAF50;
        }
        label {
            display: block;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        input, button {
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #333;
            box-sizing: border-box;
        }
        input {
            background-color: #333;
            color: #fff;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #map {
            width: 80%;
            height: 250px;
            margin: 20px auto;
        }
        h3 {
            font-size: 18px;
            color: #333;
        }
        .valores-justos {
            margin-top: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Motoristas Particulares em Porto Seguro</h2>
        <div class="informacoes-adicionais">
            <p>Os valores informados consideram o tempo perdido em lentidões e engarrafamentos.</p>
            <p>O valor apresentado reflete a qualidade do serviço oferecido.</p>
            <p>O pagamento deverá ser realizado diretamente ao motorista. Verifique as formas de pagamento aceitas.</p>
        </div>

        <label>Origem:</label>
        <input type="text" id="origem" placeholder="Obtendo localização..." onclick="habilitarAlterarOrigem()" disabled>
        
        <label>Destino:</label>
        <input type="text" id="destino" placeholder="Digite o destino" oninput="habilitarCalcular()">
        
        <button onclick="calcularRota()" id="botaoCalcular" disabled>Calcular</button>
        <h3 id="resultado">Custo total: R$ 0,00</h3>
        <label>Informe seu número do WhatsApp:</label>
        <input type="text" id="whatsapp" placeholder="Digite seu número do WhatsApp" maxlength="15">
        <button id="botaoWhatsapp" style="display:none;" onclick="enviarMensagemTelegram()">Solicitar Viagem</button>
        
        <div id="timer" style="display: none;">
            <h3 id="contagem-regressiva">Tempo restante: 5:00</h3>
            <p>Em até 5 minutos responderemos sua solicitação.</p>
        </div>
    </div>

    <div id="map"></div>

    <script>
        let map, origemLatLng, destinoLatLng, enderecoOrigem;
        let timer;
        let tempoLimite = 300; // 5 minutos em segundos

        // Configurações do Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoicmFwaGFtYWNlZG8iLCJhIjoiY203bWE5cmR4MGtlazJrcHM3ajI0ems0dyJ9.7kHw1-KpcSnC_qQyrspXIw'; // Token público

        function habilitarCalcular() {
            let origem = document.getElementById('origem').value;
            let destino = document.getElementById('destino').value;
            document.getElementById('botaoCalcular').disabled = !(origem && destino);
        }

        function habilitarAlterarOrigem() {
            document.getElementById('origem').disabled = false;
        }

        function calcularRota() {
            if (!origemLatLng) {
                alert("Origem não definida. Aguarde até que a localização seja obtida.");
                return;
            }

            const destino = document.getElementById('destino').value;

            // Obtendo as coordenadas do destino usando a API do Mapbox
            fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(destino)}.json?access_token=${mapboxgl.accessToken}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Erro ao buscar coordenadas do destino.");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        destinoLatLng = data.features[0].geometry.coordinates;
                        const origem = `${origemLatLng.lng},${origemLatLng.lat}`;
                        const destinoStr = `${destinoLatLng[0]},${destinoLatLng[1]}`;

                        fetch(`https://api.mapbox.com/optimized-trips/v1/mapbox/driving/${origem};${destinoStr}?access_token=${mapboxgl.accessToken}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error("Erro ao calcular a rota.");
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.routes && data.routes.length > 0) {
                                    const route = data.routes[0];
                                    const tempo = route.duration / 60; // em minutos
                                    const distancia = route.distance / 1000; // em km
                                    calcularCusto(tempo, distancia);

                                    // Adiciona a rota ao mapa
                                    const geojson = {
                                        type: 'Feature',
                                        geometry: {
                                            type: 'LineString',
                                            coordinates: route.geometry.coordinates
                                        }
                                    };

                                    // Adiciona a rota ao mapa
                                    map.addLayer({
                                        id: 'rota',
                                        type: 'line',
                                        source: {
                                            type: 'geojson',
                                            data: geojson
                                        },
                                        layout: {
                                            'line-join': 'round',
                                            'line-cap': 'round'
                                        },
                                        paint: {
                                            'line-color': '#888',
                                            'line-width': 8
                                        }
                                    });
                                } else {
                                    alert('Erro: Não foi possível encontrar uma rota.');
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao calcular a rota:', error);
                                alert('Erro ao calcular a rota: ' + error.message);
                            });
                    } else {
                        alert('Destino não encontrado. Tente outro endereço.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar coordenadas do destino:', error);
                    alert('Erro ao buscar coordenadas do destino: ' + error.message);
                });
        }

        function calcularCusto(tempo, distancia) {
            let valorInicial = 5.00;
            let valorPorMinuto = 0.75;
            let valorPorKm = 2.00;
            let adicional = 0;

            if (isArraial(destinoLatLng)) {
                tempo += 30; // adiciona 30 minutos
            }

            let agora = new Date();
            let hora = agora.getHours();
            if (hora >= 18 || hora < 6) {
                adicional = 0.20;
            }

            let custoFinal = valorInicial + (tempo * valorPorMinuto) + (distancia * valorPorKm);
            custoFinal *= (1 + adicional);
            document.getElementById('resultado').innerText = `Custo total: R$ ${custoFinal.toFixed(2)}`;
            document.getElementById('botaoWhatsapp').style.display = "block";
        }

        function isArraial(latLng) {
            const arraialBounds = {
                north: -16.207356,
                south: -16.220085,
                east: -39.033176,
                west: -39.042950
            };
            return latLng[1] < arraialBounds.north && latLng[1] > arraialBounds.south &&
                latLng[0] < arraialBounds.east && latLng[0] > arraialBounds.west;
        }

        function enviarMensagemTelegram() { 
            let origem = enderecoOrigem || "Localização não definida";
            let destino = document.getElementById('destino').value || "Destino não informado";
            let numeroWhatsApp = document.getElementById('whatsapp').value || "Número não informado";

            // Validação do número do WhatsApp
            const whatsappRegex = /^\d{10,15}$/; // Aceita números de 10 a 15 dígitos
            if (!whatsappRegex.test(numeroWhatsApp)) {
                alert("Por favor, insira um número de WhatsApp válido.");
                return;
            }

            let linkMapbox = `https://www.mapbox.com/directions/?point=${origemLatLng.lat},${origemLatLng.lng}&point=${destinoLatLng[1]},${destinoLatLng[0]}`;

            let mensagem = `Nova solicitação de viagem:\n\nOrigem: ${origem}\nDestino: ${destino}\nNúmero do WhatsApp: ${numeroWhatsApp}\nLink da Rota: ${linkMapbox}`;
            let tokenTelegram = "SEU_TOKEN_AQUI"; // Insira seu token
            let idTelegram = "SEU_ID_AQUI"; // Insira seu ID

            // Envio da mensagem para o Telegram
            fetch(`https://api.telegram.org/bot${tokenTelegram}/sendMessage`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    chat_id: idTelegram,
                    text: mensagem,
                    parse_mode: "HTML"
                })
            })
            .then(response => {
                if (response.ok) {
                    iniciarContagemRegressiva(); // Inicia a contagem regressiva após o envio bem-sucedido
                } else {
                    alert("Erro ao enviar a mensagem. Tente novamente.");
                }
            })
            .catch(error => console.error("Erro:", error));
        }

        function iniciarContagemRegressiva() {
            document.getElementById('timer').style.display = "block";
            let contagemRegressiva = tempoLimite;
            timer = setInterval(() => {
                let minutos = Math.floor(contagemRegressiva / 60);
                let segundos = contagemRegressiva % 60;
                document.getElementById('contagem-regressiva').innerText = `Tempo restante: ${minutos}:${segundos < 10 ? '0' : ''}${segundos}`;
                contagemRegressiva--;
                if (contagemRegressiva < 0) {
                    clearInterval(timer);
                    alert("O tempo para resposta expirou.");
                }
            }, 1000);
        }

        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [-39.0603, -16.2564], // Centro de Porto Seguro
                zoom: 12
            });

            map.on('load', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        origemLatLng = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        enderecoOrigem = `${position.coords.latitude}, ${position.coords.longitude}`;
                        document.getElementById('origem').value = "Sua localização";
                        
                        // Atualiza a origem no mapa
                        new mapboxgl.Marker().setLngLat(origemLatLng).addTo(map);
                        
                        // Chama calcularRota somente após obter a origem
                        calcularRota(); // Chama calcular rota após obter a origem
                    }, (error) => {
                        console.error("Erro ao obter localização:", error);
                        alert("Não foi possível obter sua localização.");
                    });
                } else {
                    alert("Geolocalização não suportada pelo seu navegador.");
                }
            });
        }

        initMap();
    </script>
</body>
</html>
